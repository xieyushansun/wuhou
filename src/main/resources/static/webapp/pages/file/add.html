<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>添加档案</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../layui/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/layuimini.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
    <link rel="stylesheet" href="../../css/viewer.min.css">

    <style>
        body {
            background-color: #ffffff;
        }
        .add-form {margin: 0 auto;}
        
        @media screen and (min-width: 642px) {
            .add-form {
                width: 642px;
                margin: 10px auto;
            }
        }

        @media screen and (min-width: 965px) {
            .add-form {
                width: 965px;
                margin: 10px auto;
            }
            .layui-upload {
                margin: 0 80px;
            }
        }

    </style>
</head>
<body>
    <div class="layuimini-container">
        <div class="layuimini-main">
            <fieldset class="table-search-fieldset">
                <div style="margin: 10px 10px 10px 10px">
                    <button class="layui-btn layui-btn-xs" id="continue-add">继续添加</button>
                </div>
            </fieldset>
            <div class="add-form">
                <div class="layui-form layuimini-form layui-form-pane" lay-filter="add-form">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">档号</label>
                            <div class="layui-input-inline">    
                                <input type="text" name="documentNumber" lay-verify="required" lay-reqtext="档号不能为空" value="" class="layui-input" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">全宗号</label>
                            <div class="layui-input-inline">
                                <select name="recordGroupNumber" class="docNoUsed" lay-verify="required">
                                    <option value="129">129</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">年度</label>
                            <div class="layui-input-inline">
                                <input type="text" name="year" lay-verify="required" lay-reqtext="年度不能为空" value="" class="layui-input docNoUsed" id="year">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">保管期限</label>
                            <div class="layui-input-inline">
                                <select name="duration" class="docNoUsed" lay-verify="required" lay-filter='duration'>
                                <option value=""></option>
                                    <option value="10年">10年</option>
                                    <option value="30年">30年</option>
                                    <option value="50年">50年</option>
                                    <option value="100年">100年</option>
                                    <option value="永久">永久</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">密级</label>
                            <div class="layui-input-inline">
                                <input type="text" name="security" value="" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">档案类别</label>
                            <div class="layui-input-inline">
                                <select name="documentCategory" class="docNoUsed" lay-verify="required" lay-reqtext="档案类别不能为空" lay-filter='documentCategory'></select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">案卷类别</label>
                            <div class="layui-input-inline">
                                <select name="fileCategory" class="docNoUsed" lay-verify="required" lay-reqtext="案卷类别不能为空" lay-filter='fileCategory'></select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">案卷号</label>
                            <div class="layui-input-inline">
                                <input type="text" name="boxNumber" lay-verify="required" lay-reqtext="案卷号不能为空" value="" class="layui-input docNoUsed" placeholder="盒号">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">责任者</label>
                            <div class="layui-input-inline">
                                <input type="text" name="responsible" value="" class="layui-input" autocomplete="off">
                                <!-- <tip>填写自己管理账号的名称。</tip> -->
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">单位代码</label>
                            <div class="layui-input-inline">
                                <input type="text" name="danweiCode" class="layui-input" placeholder="(社会保障号码)" autocomplete="off">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">单位名称</label>
                            <div class="layui-input-inline">
                                <input type="text" name="danweiName" class="layui-input" placeholder="(姓名)" autocomplete="off">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">案卷题名</label>
                            <div class="layui-input-inline">
                                <input type="text" name="fileName" lay-verify="required" lay-reqtext="案卷题名不能为空" value="" class="layui-input" autocomplete="off">
                            </div>
                        </div>
                        <!-- <div class="layui-inline">
                            <label class="layui-form-label">分类号</label>
                            <div class="layui-input-inline">
                                <input type="text" name="classNumber" lay-verify="" lay-reqtext="目录号不能为空" value="" class="layui-input">
                            </div>
                        </div> -->
                        <div class="layui-inline">
                            <label class="layui-form-label">存放位置</label>
                            <div class="layui-input-inline">
                                <input type="text" name="position" lay-verify="" lay-reqtext="存放位置不能为空" value="" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">著录人</label>
                            <div class="layui-input-inline">
                                <input type="text" name="recorder" class="layui-input layui-disabled" readonly>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">著录时间</label>
                            <div class="layui-input-inline">
                                <input type="text" name="recordTime"class="layui-input layui-disabled" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button type="submit" id="save" class="layui-btn" lay-submit lay-filter="saveBtn">保存</button>
                            <button id="mount-btn" class="layui-btn layui-btn-normal layui-disabled" lay-filter="mountBtn">
                                <i class="layui-icon layui-icon-upload"></i>
                                挂载文件
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="layuimini-container" id="upload-container" style="display: none;">
        <div class="layuimini-main">
            <div class="layui-upload">
                <button type="button" class="layui-btn layui-btn-normal" id="testList">选择多文件</button> 
                <div class="layui-upload-list">
                  <table class="layui-table">
                    <thead>
                      <tr><th>文件名</th>
                      <th>预览</th>
                      <th>状态</th>
                      <th style="width: 150px;">操作</th>
                    </tr></thead>
                    <tbody id="fileList"></tbody>
                  </table>
                </div>
                <button type="button" class="layui-btn" id="testListAction">开始上传</button>
              </div> 
        </div>
    </div>

    <div class="layui-hide">
        <ul id="images"></ul>
    </div>    

<!-- <script type="text/html" id="uploadTpl">
    <table class="layui-table">
        <thead>
            <tr>
                <th>序号</th>
                <th>文件目录</th>
                <th>已传文件</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {{# layui.each(d, function(index, item) { }}
                <tr id="file"+index >
                    <td>item</td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            {{# }); }}
        </tbody>
    </table>
    <a class="layui-tbn layui-btn-xs" lay-event="upload"><i class="layui-icon layui-icon-upload"></i>上传</a>
</script> -->
<script src="../../js/jquery.min.js"></script>
<script src="../../js/jquery.cookie.js"></script>
<script src="../../js/viewer.min.js"></script>
<script src="../../layui/layui.js" charset="utf-8"></script>
<script src="../../js/document-category-render.js"></script>
<script src="../../js/get-user.js"></script>
<script>
    layui.use(['form', 'layer', 'upload', 'util'], function () {
        var form = layui.form,
            layer = layui.layer,
            upload = layui.upload,
            util = layui.util;
        var Viewer = window.Viewer;

        var documentCategoryData = parent.documentCategoryData;
        var documentCatAbbr = getDocCatAbbr(documentCategoryData);
        var documentCategoryList = parent.documentCategoryList,
            fileCategoryList = parent.fileCategoryList;
        var documentCategory = parent.documentCategory,
            fileCategory = parent.fileCategory;

        var durationDict = {
            '10年': 'D',
            '30年': 'Z',
            '50年': 'C',
            '100年': 'H',
            '永久': 'Y'
        };
        
        var username = $.cookie("nickname");
        var viewer = new Viewer(document.getElementById('images'), {
            toolbar: true,
        }), 
            imgIdx = 0;

        $(document).ready(function(){
            selectInit(documentCategoryData, add=true);
            var user = getUser();
            form.val("add-form", {
                //
                "documentCategory": documentCategory,
                "fileCategory": fileCategory,
                "recorder": user.username,
                "recordTime": getDate()
            });
            form.render('select');
        });

        // laydate.render({
        //     elem: "#year",
        //     type: 'year',
        //     // showBottom: false,
        //     done: function(value, date, endDate) {
        //         makeDocumentNo();
        //     }
        // });

        
        $(".docNoUsed").change(function() {
            makeDocumentNo();
        });

        // 继续添加按钮的点击
        $("#continue-add").on('click', function() {
            form.val('add-form', {
                "documentNumber": "",
                "year": "",
                "duration": "",
                "security": "",
                "documentCategory": documentCategory,
                "fileCategory": fileCategory,
                "boxNumber": "",
                "responsible": "",
                "danweiCode": "",
                "danweiName": "",
                "fileName": "",
                "position": "",
                "recorder": $.cookie('nickname'),
                "recordTime": getDate()
            });
            $("#save").removeClass("layui-disabled").removeAttr("disabled");
            $("#mount-btn").addClass("layui-disabled");
            $("#fileList").empty();
            $("#upload-container").css("display", "none");
        });

        // 监听案卷类别下拉选择的变化
        form.on('select(documentCategory)', function(data) {
            makeDocumentNo();
            documentCategory = data.value;
            fileCategory = '';
            fileCategoryList = getFileCategoryList(documentCategoryData, documentCategory);
            changeOption('fileCategory', makeOption(fileCategoryList, documentCategory=undefined, file=true));
            form.render('select');
            console.log(documentCategory);
        });

        // 监听案卷类别下拉选择的变化
        form.on('select(fileCategory)', function(data) {
            makeDocumentNo();
            fileCategory = data.value;
        });

        form.on('select(duration)', function(data) {
            makeDocumentNo();
        });

        var documentRecordId = 3,
            fileList = ['1','2'];

        // 提交后才能挂载文件
        $('#mount-btn').on('click', function() {
            if ($(this).hasClass('layui-disabled')) {
                layer.tips('请先保存档案再挂载文档', '#mount-btn', {time: 1*1000});
                return;
            }
            // laytpl(uploadTpl.innerHTML).render(fileList, function(html) {
            //     $("#file-list").html(html);
            // });

            $("#upload-container").css("display", "block");

        });

        var choosedFiles = [];
        var uploadedFiles = [];
        var imgList = [];
        // 上传按钮和列表
        var fileListView = $('#fileList');
            uploadListIns = upload.render({
                elem: '#testList',
                url: '../../../document/adddocumentrecordfile',
                accept: 'file',
                multiple: true,
                auto: false,
                bindAction: '#testListAction',
                choose: function(obj) {
                    var files = this.files = obj.pushFile(); //将每次选择的文件追加到文件队列
                    //读取本地文件
                    obj.preview(function(index, file, result) {
                        if (uploadedFiles.indexOf(file.name) !== -1) {
                            layer.msg('已上传过名为\"' + file.name + '\"的文件', {icon: 2, anim: 6}); // 已上传重名文件
                            delete files[index];
                            return;
                        } else if (choosedFiles.indexOf(file.name) !== -1) {
                            layer.msg('已选择过名为\"' + file.name + '\"的文件', {icon: 2, anim: 6}); // 已选择重名文件
                            delete files[index];
                            return;
                        }
                        choosedFiles.push(file.name);

                        var tr = '';
                        if (file.type.split('/')[0] === 'image') {
                            tr = $([
                                '<tr id="upload-' + index + '">', 
                                    '<td>' + file.name + '</td>',
                                    '<td><div><img src="' + result + '" style="width: 30px; height:30px;"></div></td>', 
                                    '<td>等待上传</td>', 
                                    '<td>', 
                                        '<button class="layui-btn layui-btn-primary layui-btn-xs view-file file-btn" data-name="' + file.name + '">查看</button>',
                                        '<button class="layui-btn layui-btn-xs demo-reload layui-hide">重传</button>', 
                                        '<button class="layui-btn layui-btn-xs layui-btn-danger demo-delete" data-name="' + file.name + '">删除</button>', 
                                    '</td>', 
                                '</tr>'].join(''));
                            $("#images").append("<li><img src='" + result + "' alt='" + file.name + "'></li>");
                            imgIdx++;
                            imgList.push(file.name);
                            viewer.update();
                        } else {
                            tr = $(['<tr id="upload-' + index + '">', '<td>' + file.name + '</td>','<td>' + file.type + '</td>' , '<td>等待上传</td>', '<td>','', '<button class="layui-btn layui-btn-xs demo-reload layui-hide">重传</button>', '<button class="layui-btn layui-btn-xs layui-btn-danger demo-delete">删除</button>', '</td>', '</tr>'].join(''));
                        }

                        //单个重传
                        tr.find('.demo-reload').on('click', function() {
                            obj.upload(index, file);
                        });

                        // 图片预览
                        tr.find('.view-file').on('click', function() {
                            var filename = $(this).data()['name'],
                                index = imgList.indexOf(filename);
                            viewImg(index);
                        });

                        //删除
                        tr.find('.demo-delete').on('click', function() {
                            var filename = $(this).data()['name'];
                            var uploadedIdx = -1;
                            var thatIdx = index;
                            if ((uploadedIdx = uploadedFiles.indexOf(files[thatIdx].filename)) !== -1) {
                                if (deleteFile(documentRecordId, files[thatIdx].filename)) { // 删除成功
                                    uploadedFiles.splice(uploadedIdx, 1); // 如果该文件在已上传文件列表中，需要从列表中删除，并从服务器删除。
                                    tr.remove();
                                    uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
                                }
                            } else {
                                delete files[thatIdx]; // 该文件未上传，只从上传列表删除对应的文件
                                tr.remove();
                                uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
                            }
                            $('#images').find('li img[alt="' + filename+ '"]').remove(); // 删除ul中的li
                            viewer.update(); // 因为从ul中删除，更新viewer；
                            var imgIdxx = imgList.indexOf(filename);
                            if (imgIdxx > -1) {
                                imgList.splice(imgIdxx, 1); // 从imgList中删除该文件
                            }
                            
                            imgidxx = choosedFiles.indexOf(filename);
                            if (imgIdxx > -1) {
                                choosedFiles.splice(imgIdxx, 1); // 从choosedFiles中删除
                            } 
                        });
                        fileListView.append(tr); 
                    });
                },
                done: function(res, index, upload) {
                    if (res.code === 0) { //上传成功
                        var tr = fileListView.find('tr#upload-' + index),
                            tds = tr.children();
                        tds.eq(2).html('<span style="color: #5FB878;">上传成功</span>');
                        tds.eq(3).find('.demo-reload').addClass('layui-hide');
                        uploadedFiles.push(this.files[index].filename); // 在已上传文件中添加该文件
                        return delete this.files[index]; //删除文件队列已经上传成功的文件
                    }
                    this.error(index, upload, res.message);
                },
                error: function(index, upload, msg=undefined) {
                    var tr = fileListView.find('tr#upload-' + index),
                        tds = tr.children();
                    if (msg !== undefined) { // 如果有错误信息则显示错误信息
                        tds.eq(2).html('<span style="color: #FF5722;">' + msg +'</span>');
                    } else { // 一般是网络问题造成的错误
                        tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
                        tds.eq(3).find('.demo-reload').removeClass('layui-hide'); //显示重传
                    }

                }
            });

        //监听提交
        form.on('submit(saveBtn)', function (data) {
            if ($(this).hasClass('layui-disabled')) {
                return;
            }
            // $("#mount-btn").removeClass("layui-disabled");
            // $("#save").addClass("layui-disabled").attr("disabled", "true");
            $.ajax({
                type: "post",
                url: '../../../document/adddocumentrecord',
                data: data.field,
                success: function(res) {
                    if (res.code == 0) {
                        layer.msg(res.message, {icon: 1});
                        documentRecordId = res.body;
                        $("#mount-btn").removeClass("layui-disabled");
                        $("#save").addClass("layui-disabled").attr("disabled", "true");
                        uploadListIns.reload({ // 重载上传实例
                            data: {documentRecordId: documentRecordId}
                        });
                    } else if (res.code === 12) {
                        layer.msg('登录已失效', {time: 0.8*1000, anim: 6}, function() {
                            top.location.href = '../../login.html';
                        });
                    } else {
                        layer.msg(res.message, {time: 0.8*1000, icon: 2});
                    }
                },
                error: function(jqxhr, textStatus, errorThrown) {
                    layer.alert([textStatus, errorThrown].join(':'), {icon: 2});
                    console.log('error: add document record request error');
                }
            });
            
            return false;
        });

        // 生成档号
        function makeDocumentNo() {
            var formData = form.val('add-form');
            var recordGroupNumber = formData.recordGroupNumber,
                year = formData.year,
                duration = formData.duration, 
                documentCategory = formData.documentCategory,
                fileCategory = formData.fileCategory,
                boxNumber = formData.boxNumber;

            if (recordGroupNumber !== "" && year !== "" && duration !== "" && 
                documentCategory !== "" && fileCategory !== "" && boxNumber !== "") {
                var fileIndex = fileCategoryList.indexOf(fileCategory);
                var no = fileIndex < 10? '0' + (fileIndex + 1).toString(): (fileIndex + 1).toString();
                var documentNumber = recordGroupNumber + '-' + year + '-' + durationDict[duration] + '.' + 
                                     documentCatAbbr[documentCategory] + '.' + no +
                                     '-' + boxNumber;
                form.val('add-form', {
                    "documentNumber": documentNumber
                });
            }
        }

        function viewImg(idx) {
            viewer['view'](idx.toString());
        }
        
        // 获取格式为yyyymmdd的日期
        function getDate() {
            return util.toDateString(new Date(), 'yyyyMMdd');
        }

        // 删除服务器上的文件
        function deleteFile(documentRecordId, filename) {
            /**
             * @description: 删除服务器上的文件
             * @param {documentRecordId: String} 档案ID 
             * @param {filename: String} 文件名
             * @return  返回成功与否{true/false: boolean}
             */
            var successful = false;
            $.ajax({
                url: '../../../deleteDocumentRecordFile', 
                type: 'post',
                data: {documentRecordId: documentRecordId, fileName: filename},
                success: function(res) {
                    if (res.code === 0) {
                        layer.msg('删除成功');
                        successful = true
                    } else if (res.code === 12) {
                        layer.msg('登录已失效', {time: 0.8*1000, anim: 6}, function() {
                            top.location.href = '../../login.html';
                        });
                    } else {
                        layer.msg(res.message, {time: 0.8*1000, icon: 2});
                        successful = false;
                    }
                },
                error: function(jqxhr, textStatus, errorThrown) {
                    layer.alert([textStatus, errorThrown].join(':'), {icon: 2});
                    console.log('error: delete document record file request error');
                }
            });
            return successful;
        }
    });
</script>
</body>
</html>
